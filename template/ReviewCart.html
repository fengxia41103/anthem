{% extends "/template/OrderBase.html" %}

{% block customJS %}
<script type="text/javascript">
    j$(document).ready(function(){
    	{% if cart.status=='Open' or cart.status=='Rejected' %}
    		j$('input[type="number"]').prop('disabled', false);
    	{% elif cart.status=='Ready for Processing' %}
    		j$('input[type="number"]').prop('disabled', true);
    		j$('input[name^="shipping"]').prop('disabled', false);

    	{% else %}
    		j$('input[type="number"]').prop('disabled', true);
		{% endif %}
		
					    
		// remove item from cart
		j$(document).on('click','.command-link[item="buyorder-fill-remove"]',function(){
			// call Server to remove this FillOrder from Cart
			var id=j$(this).attr('itemId');
			var tr=j$(this).closest('tr');			

			j$.post(
				'{{ url }}?cart={{ cart.key.id() }}',
				{'cart':{{cart.key.id()}},'action':'remove','id':id,'kind':'BuyOrderFill'},
				function(result){
					switch(result){
						case '0': // success
							j$().toastmessage('showNoticeToast', "Item has been removed from your cart");
							tr.fadeOut(500,function(){
								j$(this).remove();
							});
							
							// if this is the last row, we now have an empty cart
							// redirect to browse page
							window.location.href = "/buyorder/browse";
							break;
						default:
							break;
					}
				}
			);			
		});
				
		// change client price		
		j$(document).on('change','input[item="client-price"]',function(){
			var id=j$(this).attr('itemId');
			var newVal=j$(this).val();
			
			j$.post(
				'{{ url }}?cart={{ cart.key.id() }}',
				{'cart':{{cart.key.id()}},'action':'update client price','id':id,'kind':'BuyOrderFill','price':newVal},
				function(result){
					switch(result){
						case '0': // success
							j$().toastmessage('showNoticeToast', "New price of "+newVal+' has been received');
							break;
						default:
							break;
					}
				}
			);			
		});

		// update qty and price
		j$(document).on('change','input[item="fill-qty"]',function(){
			var id=j$(this).attr('itemId');
			var newVal=j$(this).val();
			j$.post(
				'{{ url }}?cart={{ cart.key.id() }}',
				{'cart':{{cart.key.id()}},'action':'update fill qty','id':id,'kind':'BuyOrderFill','qty':newVal},
				function(result){
					switch(result){
						case '0': // success
							j$().toastmessage('showNoticeToast', "New quantity of "+newVal+' has been received');
							break;
						default:
							break;
					}
				}
			);			
		});
		j$(document).on('change','input[item="fill-price"]',function(){
			var id=j$(this).attr('itemId');
			var newVal=j$(this).val();
			j$.post(
				'{{ url }}?cart={{ cart.key.id() }}',
				{'cart':{{cart.key.id()}},'action':'update fill price','id':id,'kind':'BuyOrderFill','price':newVal},
				function(result){
					switch(result){
						case '0': // success
							j$().toastmessage('showNoticeToast', "New price of "+newVal+' has been received');
							break;
						default:
							break;
					}
				}
			);			
		});
		
		// approval process
		j$(document).on('click','button[item="approval-process"]',function(){
			var action=j$(this).html();
			j$.post(
				'/cart/review?cart={{ cart.key.id() }}',
				{'cart':{{cart.key.id()}},'action':action,'kind':'BuyOrderCart','id':'12345'}, // id is not used in this POST, so anything
				function(result){
					j$().toastmessage('showNoticeToast','Cart status has been updated');
				}
			);			
		});
				
		// full screen switch
		j$('#full-screen-switch-1').on('click',function(){
			j$('.arrow_box').fadeIn(500);	
			j$(this).toggle();
			j$('#full-screen-switch-2').toggle();
		});
		j$('#full-screen-switch-2').on('click',function(){
			j$('.arrow_box').fadeOut(500);	
			j$(this).toggle();
			j$('#full-screen-switch-1').toggle();	
		});
	    
	    // shopping cart animation
	    j$('#shopping-cart-collapse-switch').on('click',function(){
	    	j$(this).parents('div.shopping-cart-pane').slideToggle(600,function(){
	    		j$('#shopping-cart-visible-switch').fadeIn(400);
	    	});
	    	
	    });
	    j$('#shopping-cart-visible-switch').on('click',function(){
	    	j$(this).hide();
	    	j$(this).siblings('div.shopping-cart-pane').slideToggle(600);
	    });
	    
	    // level 2 navigation
	    j$('.level-2-navigation').show();
	    j$('#nav-cart-review').addClass('level-2-navigation-selected');
    });
</script>
{% endblock %}

{% block main %}
    <h1 class="ariel-blue">Review Your Shopping Cart and Place Order</h1>
    <p class="ariel-blue ariel-p">
    	Review items in your shopping cart and submit. You can monitor the status of your orders
    	at any time.
    </p>
        
	{% if cart.fills|length > 0 %}
	<div>
	{% if cart.status=='Open' and me.can_be_nur() %}
		<button class="my-button" item="approval-process">Submit for Approval</button>
	{% elif cart.status=='Rejected' and me.can_be_nur() %}
		<button class="my-button" item="approval-process">Submit for Approval</button>
	{% elif cart.status=='Rejected' and me.can_be_doc() %}
		<button class="my-button" item="approval-process">Approve</button>
	{% elif cart.status=='In Approval' and me.can_be_doc() %}
		<button class="my-button" item="approval-process">Approve</button>
		<button class="my-button" item="approval-process">Reject</button>
	{% endif %}
	</div>

	<!-- Shipping inputs are available after approval and for DOC -->
	{% if cart.status=='Ready for Processing'  and me.can_be_doc() %}
	<div class="shopping-cart-pane" style="display:none;">
		<span id="shopping-cart-collapse-switch" title="Click to collapse cart view" style="text-decoration:underline;float:right;">
			Close
		</span>

		<h1 class="ariel-blue">Enter Shipping Information</h1>		
		<div>
		<label class="ss-label">Select a shipping method</label>
		<br />
		<select class="ss-select" name="shipping-carrier">
			{% for s in shipping_methods %}
				<option value="{{ s }}">{{ s }}</option>
			{% endfor %}
		</select>
		</div>
		<br />
				
		<div>
		<label class="ss-label">Tracking Number</label>
		<br />
		<input class="ss-input" type="text" name="shipping-tracking" id="input-tracking-number" placeholder="eg. 013840222514114"/>
		</div>

		<table class="two-col-table">
			<tr>
				<td>
					<label>Number of Packages</label>
					<br />
					<input type="number" name="shipping-number-of-package" id="input-number-of-package" placeholder="1"/>					
				</td>
				<td>
					<label>Cost</label>
					<br />
					<input type="number" name="shipping-cost" step="any" placeholder="0.0"/>
				</td>
			</tr>
		</table>		
		
		<div>
		<label class="ss-label">Upload Shipping Label File</label>
		<br />
		<input class="ss-input" type="file" name="shipping-label" id="input-shipping-label-file" />
		</div>
		{#		
		<table class="ariel-table">
		<tr><td>
			Select a carrier
		</td><td>
			<select>
				<opton value="this">this</option>
				<opton value="that">that</option>
			</select>

		</td></tr>
		
		<tr><td>
			Enter tracking number
		</td><td>
			<input type="text" id="input-tracking-number" placeholder="eg. 013840222514114"/>
		</td></tr>
		
		<tr><td>
			Enter number of packages
		</td><td>
			<input type="number" id="input-number-of-package" placeholder="eg. 5"/>
		</td></tr>
		
		<tr><td>
			Upload shipping label file
		</td><td>
			<input type="file" id="input-shipping-label-file" />
		</td></tr>
		
		<tr><td>
			Enter shipping cost
		</td><td>
			<input type="number" step="any" placeholder=""/>
		</td></tr>
		</table>
		#}
		
		<p class="ariel-blue">
		Please verify the shipment information and click the "Create Shipment" button below.
		Shiping label file will be emailed to all buyers and sellers.
		</p>
		<button class="my-button">Create Shipment</button>
	</div>   
	<div id="shopping-cart-visible-switch">Enter a shipping label &nbsp;</div>
	{% endif %}
	
	<div class="quick-pane" id="sec-summary">
	<h3>Cart Summary</h3>
	<table class="sf-table table-row-border">
		<tr><td>Cart Name</td>
			<td>Cart# {{ cart.key.id() }}</td>
			<td>Created Date</td>
			<td>{{ cart.created_time }}</td>
		</tr><tr>
			<td>Buyer Name</td>
			<td>
				{% if cart.broker %}
					{{ cart.broker.get().nickname }}
				{% endif %}
			</td>
			<td>Seller Name</td>
			<td>{{ cart.terminal_seller.get().nickname }}</td>
		</tr>
	</table>
	</div>					
	
	<div class="quick-pane" id="sec-status">
	<h3>Status</h3>
	<table class="sf-table table-row-border">
		<tr><td>Status</td>
			<td>{{ cart.status }}</td>
			<td>Shipping Status</td>
			<td>{{ cart.shipping_status }}</td>
		</tr><tr>
			<td>Buyer Reconciled</td>
			<td>{{ cart.buyer_reconciled }}</td>
			<td>Seller Reconciled</td>
			<td>{{ cart.seller_reconciled }}</td>
		</tr>
	</table>
	</div>
	
	<!-- DOC only views -->
	{% if me.can_be_doc() %}
		<div class="quick-pane" id="sec-profit">
		<h3>Profit</h3>
		<table class="sf-table table-row-border">
			<tr><td>Expected Profit</td>
				<td>{{ cart.profit }}</td>
				<td>Expected Gross Margin</td>
				<td>{{ cart.gross_margin}}%</td>
			</tr>
			<tr><td>Realized Profit</td>
				<td>{{ cart.realized_profit }}</td>
				<td>Realized Gross Margin</td>
				<td>{{ cart.realized_gross_margin }}</td>
			</tr>
		</table>
		</div>
	
		<div class="quick-pane" sec="sec-accounting">
		<h3>Accounting</h3>
		<table class="sf-table table-row-border">
			<tr><td>Total Payable</td>
				<td>{{ cart.payable }}</td>
				<td>Total Receivable</td>
				<td>{{ cart.receivable }}</td>
			</tr>
			<tr><td>Bank Withdraw</td>
				<td>{{ cart.payout }}</td>
				<td>Bank Deposit</td>
				<td>{{ cart.payin }}</td>
			</tr>
			<tr>
				<td>Payable Balance</td>
				<td>{{ cart.payable_balance }}</td>
				<td>Receivable</td>
				<td>{{ cart.receivable_balance }}</td>
			</tr>
		</table>
		</div>	
	
		<div class="quick-pane">
		<h3>Assign Client</h3>
		{% if cart.terminal_buyer %}
		<table class="sf-table table-row-border">
			<tr><td>Shipping Address</td>
				<td>{{ cart.terminal_buyer.get().shipping_address }}</td>
				<td>Email</td>
				<td>{{ cart.terminal_buyer.get().email }}</td>
			</tr>
		</table>
		{% endif %}
		</div>
	{% endif %}
	
	<div class="quick-pane" id="sec-fill-list">
	<h3>Item Details</h3>
	{% if cart.fills|count >0 %}
		<span id="full-screen-switch-1" class="collapse-switch">&gt;&gt; Show sell price</span>
		<span id="full-screen-switch-2" class="collapse-switch">&lt;&lt; Hide sell price</span>
		<table class="table-row-border">
			{% for f in cart.fills %}
			<tr><td><img src="{{ f.order.get().image }}" style="height:50px;padding:10px;" class="box-shadow"/></td>
				<td>
					{{ f.order.get().name }}
					<blockquote>
					{{ f.order.get().description }}
					</blockquote>
				</td>
				<td>
					{% if cart.status=='Open' or cart.status=='Rejected' %}
						<input type="number" item="fill-price" itemId="{{ f.order.id() }}" value="{{ f.price }}" step="any"/>	
					{% else %}
						{{ f.price }}
					{% endif %}
					<div class="arrow_box" style="display:none;">
						<label>Sell price: </label>
						<input type="number" item="client-price" itemId="{{ f.order.id() }}" value="{{ f.client_price }}" step="any"/>	
					</div>
				</td>
				<td>
					{% if cart.status=='Open' or cart.status=='Rejected' %}
						<input type="number" item="fill-qty" itemId="{{ f.order.id() }}" value="{{ f.qty }}" step="any"/>	
					{% else %}
						{{ f.qty }}
					{% endif %}
				</td>
				<td><span class="command-link" itemId="{{ f.order.id() }}" item="buyorder-fill-remove">Remove</span></td>
			</tr>
			{% endfor %}
		</table>
	{% endif %}
	</div>

	<div class="quick-pane" id="sec-shipping-summary">
	<h3>Shipping Summary</h3>
	<table class="sf-table table-row-border">
		<tr><td>Created On</td>
			<td>{{ cart.shipping_created_date }}</td>
			<td>Carrier</td>
			<td>{{ cart.shipping_carrier }}</td>
		</tr>
		<tr><td>Tracking Number</td>
			<td>{{ cart.shipping_tracking_number }}</td>
			<td>No. of Packages</td>
			<td>{{ cart.shipping_num_of_package }}</td>
		</tr>
		<tr><td>Shipping Status</td>
			<td>{{ cart.shipping_status }}</td>
			<td>Shipping Cost</td>
			<td>{{ cart.shipping_cost }}</td>
		</tr>
	</table>
	</div>	

	<div class="quick-pane" id="sec-payment">
	<h3>Payments</h3>
	{% if cart.payout_slips %}
		<table class="table-row-border" style="width:49%;float:left;margin-right:5px;">
		<caption class="table-caption">Pay For This Deal</caption>
		<thead>
			<tr><td>Transaction Created On</td>
				<td>Amount</td>
				<td>Payment Method</td>
			</tr>
		</thead>
		<tbody>		
		{% for s in cart.payout_slips %}
			<tr><td>{{ s.created_time }}</td>
				<td>{{ s.amount }}</td>
				<td>{{ s.billing }}</td>
			</tr>
		{% endfor %}
		</tbody>
		</table>
	{% endif %}
	{% if cart.payin_slips %}
		<table class="table-row-border" style="width:49%;">
		<caption class="table-caption">Earn From This Deal</caption>
		<thead>
			<tr><td>Transaction Created On</td>
				<td>Amount</td>
				<td>Payment Method</td>
			</tr>
		</thead>
		<tbody>		
		{% for s in cart.payin_slips %}
			<tr><td>{{ s.created_time }}</td>
				<td>{{ s.amount }}</td>
				<td>{{ s.billing }}</td>
			</tr>
		{% endfor %}
		</tbody>
		</table>
	{% endif %}
	</div>

	{% else %}
		<h4>Your cart is empty. <a href="/buyorder/browse">Go shopping</a>!</h4>

	{% endif %}
{% endblock %}
