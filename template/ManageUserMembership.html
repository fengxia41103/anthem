{% extends "/template/UserBase.html" %}

{% block customJS %}
<script type="text/javascript">
//Success handler
	var signupSuccessHandler = function(purchaseAction){
		var orderId=purchaseAction['response']['orderId'];
		j$().toastmessage('showNoticeToast','Thank you for your subscription! Your order number is '+orderId);
    }	
	var signupFailureHandler = function(purchaseAction){
		var error=purchaseAction['response']['errorType'];
		switch (error){
			case 'MERCHANT_ERROR':
				j$().toastmessage('showErrorToast','Purchase request contains errors. Contact system Admin.');
				break;
			case 'PURCHASE_CANCELLED':
				j$().toastmessage('showErrorToast','Buyer cancelled purchase or declined payment');
				break;
			case 'POSTBACK_ERROR':
				j$().toastmessage('showErrorToast','Failure to acknowledge postback notification');
				break;
			case 'INTERNAL_SERVER_ERROR':
				j$().toastmessage('showErrorToast','Internal Google error');
				break;
				
		}
    }	

	j$(document).ready(function(){
		// overlay
		j$('div.overlay').click(function(e){
			var pos=j$('div.pin-in-focus').offset();
			var width=j$('div.pin-in-focus').outerWidth();
			var height=j$('div.pin-in-focus').outerHeight();
			var out=false;
			if ((e.pageX<pos.left) || (e.pageX>(pos.left+width))){
				out=true;
			}
			if ((e.pageY<pos.top) || (e.pageY>(pos.top+height))){
				out=true;
			}
			
			// NOTE: click on SELECT will not close overlay
			if (out==true && !j$(e.target).is('select')){
				j$(this).fadeOut(200);
			}
		});
		
		// membership start date always default to today!
		
		// this is a manual solution for now before we implement PayPal callback
		j$('#btn-save-new-membership').click(function(){
			data=[];
			j$.each(j$('#table-new-membership tbody tr'),function(index,val){
				var role=j$(val).find('select[item="membership-role"]').val();
				var startDate=j$(val).find('span[item="membership-start-date"]').html();
				data.push({'role':role,'start date':startDate});		
			});
			
			j$.post(
				'/user/membership/new',
				JSON.stringify(data), // this is important!
				function(result){
					switch(result){
						case '-1':
							j$().toastmessage('showErroToast','You can not add roles that you already have. If yours has expired, renew it.');
							break;
						case '0':
							j$().toastmessage('showSuccessToast','Thank you! Your new membership will be activated as soon as we have processed your request.');
							break; 
					}	
				}
			);
		});
		
		// cancel membership
		j$('span[item="cancel-membership"]').click(function(){
			j$.post(
				'/user/membership/cancel/'+j$(this).attr('role')+'/',
				function(result){
					j$().toastmessage('showSuccessToast','Thank you for using our service. Hope we will see you soon.');
				}
			);
		});
		
		// level 1 navigation
		j$('#nav-user').addClass('level-1-navigation-selected');
		
		// level 2 navigation
		j$('.level-2-navigation').show();
		j$('#nav-user-membership').addClass('level-2-navigation-selected');
		
		// signup membership
		j$('span[item="signup-membership"]').click(function(){
			var role=j$(this).attr('role');
			j$.post(
				'/wallet/token',
				{'role':role},
				function(result){
					// we get a token
					google.payments.inapp.buy({
						'jwt'     : result,
						'success' : signupSuccessHandler,
						'failure' : signupFailureHandler
					});
				}
			);
		});
	});
</script>
{% endblock %}

{% block main %}
<h1 class="ariel-blue">Memberships</h1>

<p class="ariel-blue ariel-p">
You can <strong>add</strong> or <strong>cancel</strong> a membership at any time to have the optimal functions
supporting your business. <a href="">Learn more</a> of different memberships and choose the ones that best fit your interest.
</p>

<div class="quick-pane">
	<table class="table-row-border">
	<thead>	<tr><td>Role</td>
				<td>Status</td>
				<td>Payment ID</td>
				<td></td>
			</tr>
	</thead>
	<tbody>
		<!-- signed memberships -->
		{% for m in me.memberships %}
			<tr><td>{{ m.role }}</td>
				<td>
					{% if m.is_active %}
						Active
					{% else %}
						Expired
					{% endif %}
				</td>
				<td>{{ m.order_id }}</td>
				<td>
					{% if m.is_active and m.role=='Trial' %}
					{% elif m.is_active %}
						<span class="command-link" role="{{ m.role }}" item="cancel-membership">Cancel</span>
					{% else %}
						<span class="command-link" role="{{ m.role }}" item="signup-membership">Signup</span>
					{% endif %}
				</td>
			</tr>
		{% endfor %}
		
		<!-- unsigned memberships -->
		{% for m in membership_options %}
			<tr>
				<td>{{ m }}
				</td><td>
				</td><td>
					<span class="command-link" role="{{ m }}" item="signup-membership">Signup</span>
				</td>
			</tr>
		{% endfor %}
	</tbody>	
	</table>
</div>

<div class="overlay" style="display:none;" id="div-new-membership">
	<div class="pin-in-focus box-shadow">
	
		<div class="border-bottom">
			<h1>New Membership</h1>
		</div>
	
		<div>
			{#
			<span class="command-link" id="add-new-membership" style="float:right;">Add</span>
			#}
			
			<input type="submit" value="Save" id="btn-save-new-membership" class="my-button"/>
			<input type="submit" value="Renew" id="btn-renew-membership" class="my-button"/>
				
			<table class="sf-table two-col-table" id="table-new-membership">
			<thead><tr><td>Role</td><td>Start Date</td></tr></thead>
			<tbody>
				<tr><td>
					<select item="membership-role">
					
						{% for role in membership_options %}
							<option value="{{ role }}">{{ role }}</option>
						{% endfor %}
					</select>
					<span item="membership-role"></span>
					</td>
					<td>
						<span item="membership-start-date"></span>
					</td>
				</tr>
			</tbody>		
			</table>
		</div>
		
		<!-- paypal button -->		
		<div style="float:right;">
			<form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
			<input type="hidden" name="cmd" value="_s-xclick">
			<input type="hidden" name="hosted_button_id" value="MDHCW45BKX2TJ">
			<input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_subscribeCC_LG.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!">
			<img alt="" border="0" src="https://www.paypalobjects.com/en_US/i/scr/pixel.gif" width="1" height="1">
			</form>
		</div>
	</div>
</div>
{% endblock %}
