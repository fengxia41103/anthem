{% extends "/template/UserBase.html" %}

{% block customJS %}
<script type="text/javascript">
	j$(document).ready(function(){
		// overlay
		j$('div.overlay').click(function(e){
			var pos=j$('div.pin-in-focus').offset();
			var width=j$('div.pin-in-focus').outerWidth();
			var height=j$('div.pin-in-focus').outerHeight();
			var out=false;
			if ((e.pageX<pos.left) || (e.pageX>(pos.left+width))){
				out=true;
			}
			if ((e.pageY<pos.top) || (e.pageY>(pos.top+height))){
				out=true;
			}
			if (out==true){
				j$(this).fadeOut(200);
			}
		});
		
		j$(document).on('click','span[item="remove"]',function(){
            var trs=j$(this).parents('table:first').find('tbody tr');
			
            if (trs.length>1){
            	j$(this).parents('tr:first').remove();
            }else{
            	j$().toastmessage('showWarningToast','You can not remove this because at least one is required');
            }
		});
		
		j$('#show-new-membership').click(function(){
			j$('#div-new-membership').show();
		});
		
		j$('#add-new-membership').click(function(){		
            var tr=j$('#table-new-membership').find('tbody tr:last');
            j$('#table-new-membership').find('tbody').append(j$(tr).clone());
		});
		
		j$('#btn-save-new-membership').click(function(){
			data=[];
			j$.each(j$('#table-new-membership tbody tr'),function(index,val){
				var role=j$(val).find('select[item="membership-role"]').val();
				var startDate=j$(val).find('input[item="membership-start-date"]').val();
				data.push({'role':role,'start date':startDate});		
			});
			
			j$.post(
				'/user/membership/new',
				JSON.stringify(data), // this is important!
				function(result){
					switch(result){
						case '-1':
							j$().toastmessage('showErroToast','You can not add roles that you already have. If yours has expired, renew it.');
							break;
						case '0':
							j$().toastmessage('showSuccessToast','Thank you! Your new membership will be activated as soon as we have processed your request.');
							break; 
					}	
				}
			);
		});
			
		// level 1 navigation
		j$('#nav-user').addClass('level-1-navigation-selected');
		
		// level 2 navigation
		j$('.level-2-navigation').show();
		j$('#nav-user-membership').addClass('level-2-navigation-selected');
	});
</script>
{% endblock %}

{% block main %}
<h1 class="ariel-blue">Memberships</h1>

<p class="ariel-blue ariel-p">
You can <strong>add</strong> or <strong>cancel</strong> a membership at any time to have the optimal functions
supporting your business. <a href="">Learn more</a> of different memberships and choose the ones that best fit your interest.
</p>

<div class="quick-pane">
	<span class="command-link" id="show-new-membership" style="float:right;">Add a New Membership</span>
	
		
	<table class="table-row-border">
	<thead>	<tr><td>Role</td>
				<td>Status</td>
				<td>Monthly Payment ($)</td>
				<td>Last Payment Received</td>
				<td>Last Payment Amount</td>
				<td>Exipration Date</td>
				<td></td>
			</tr>
	</thead>
	<tbody>
		{% for m in me.memberships %}
			<tr><td>{{ m.role }}</td>
				<td>
					{% if m.is_active %}
						Active
					{% else %}
						Expirated
					{% endif %}
				</td>
				<td>{{ m.monthly_payment }}</td>
				<td>{{ m.last_payment_received_date }}</td>
				<td>{{ m.last_payment_amount }}</td>
				<td>{{ m.expiration_date }}</td>
				<td>
					{% if m.is_active and m.role=='Trial' %}
					{% elif m.is_active %}
						<span class="command-link">Cancel</span> | 
						<span class="command-link">Renew</span>
					{% else %}
						<span class="command-link">Renew</span>
					{% endif %}
				</td>
			</tr>
		{% endfor %}
	</tbody>	
	</table>
</div>

<div class="overlay" style="display:none;" id="div-new-membership">
	<div class="pin-in-focus box-shadow">
	
		<div class="border-bottom">
			<h1>New Membership</h1>
		</div>
	
		<div>
			<span class="command-link" id="add-new-membership" style="float:right;">Add</span>
		
			<input type="submit" value="Save" id="btn-save-new-membership" class="my-button"/>
	
			<table class="sf-table two-col-table" id="table-new-membership">
			<thead><tr><td>Role</td><td>Start Date</td></tr></thead>
			<tbody>
				<tr><td>
					<select item="membership-role">
						{% for role,fee in membership_options.iteritems() %}
							<option value="{{ role }}">{{ role }}</option>
						{% endfor %}
					</select>
					</td>
					<td>
						<input type="date" item="membership-start-date" value=""/>
						<span class="command-link" item="remove" style="float:right;">Remove</span>
					</td>
				</tr>
			</tbody>		
			</table>
		</div>
	</div>
</div>
{% endblock %}
