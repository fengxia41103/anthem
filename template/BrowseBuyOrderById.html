{% extends "/template/OrderBase.html" %}

{% block customJS %}
<script type="text/javascript">
	j$(document).ready(function(){
		// get buyorders posted by this author
		j$.post(
			'/buyorder/owner/{{ order.owner.id() }}/',
			'',
			function(result){
				var data=j$.parseJSON(result);
				
				var html='<ul>';
				for (var i=0; i<data.length;i++){
					if (i<10){
						// limit to 10
						var tt=j$.parseJSON(data[i]);
						html+='<li><img src="'+tt['image']+'" /></a></li>';
					}
				}
				html+='</ul>';
				j$('#my-list-of-buyorder').html(html);
			}
		);				
		
		j$(document).on('mouseenter','.pin-in-focus .image-house',function(){
			j$(this).find('.pin-command-center').fadeIn({duration:400});
		}).on('mouseleave','.pin-in-focus .image-house',function(){
			j$(this).find('.pin-command-center').fadeOut({duration:400});
		});
		
	    // fill order shortcut    
    	j$(document).on('click','button[item="btn-new-buyorder-fill"]',function(){
	    	var id=j$(this).attr('itemId');
	    	var price=j$('#infocus-price').val();
	    	var qty=j$('#infocus-qty').val();
	    	j$.post(
	    		'/buyorder/browse',
	    		{'id':id,'price':price,'qty':qty},
	    		function(result){
	    			j$().toastmessage('showSuccessToast','Your shopping cart has been updated.');
	    		}	
		    );
	    });
	    
	    // delete order
	    j$('#btn-delete').click(function(){
	    	var id=j$(this).attr('itemId');
			j$.post(
				'/buyorder/delete/'+id+'/',
				[],
				function(result){
					j$().toastmessage('showNoticeToast',result);	
				}
			);	    
	    });
	    
		// level 1 navigation
		j$('#nav-order').addClass('level-1-navigation-selected');
		
	});
</script>
{% endblock %}


{% block main %}
    <div class="pin-in-focus box-shadow">
    	<div class="border-bottom">
    		<h1 id="infocus-title">{{ order.owner.get().nickname }}</h1>
    		<h4>Posted On <span id="infocus-subtitle">{{ order.created_time }}</span><h4>
    	</div>
    	<div class="image-house">
    		{% if me.key == order.owner %}
				<a href="/buyorder/edit/{{ order.key.id() }}/" class="command-link">Edit</a>
				 
				{% if order.can_delete() %}
					| 
					<span class="command-link" itemId="{{ order.key.id() }}" id="btn-delete">Delete</span>
				{% endif %}

				{% if order.can_close() %}
					| 
					<span class="command-link" itemId="{{ order.key.id() }}" id="btn-close">Close</span>
				{% endif %}
				
            {% elif cart.broker %}
            	{% if cart.broker == order.owner %}
            	<div>
    			<label class="ss-label">Offer Qty</label>
  				<input  item="qty" type="number" id="infocus-qty" value="1" min="1"/>
  				<label class="ss-label">Offer Price</label>
  				<input item="price" type="number" id="infocus-price" value="{{ order.price }}" step="any" />
					<button item="btn-new-buyorder-fill" itemId="{{ order.key.id() }}">Add to cart</button>
				</div>
				{% else %}
				You can not add this item to your cart because your cart has items posted by a different user.
				{% endif %}
			{% endif %}
									
    		<img id="infocus-image" src="{{ order.image }}" />
    	</div>
    	<div class="border-bottom">
    		<h4 id="infocus-product-name">{{ order.name }}</h4>
    		<div id="infocus-product-description">{{ order.description }}</div>
    		<div style="text-align:right;">
    			{{ me.shipping_preference }}
    			<br />
    			{{ me.payment_preference }}
    		</div>
    	</div>
    	<div class="list-of-photo">
    		<h4>Similar Posts</h4>
    			<div id="my-list-of-buyorder"></div>
    	</div>
    </div>
{% endblock %}
