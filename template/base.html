<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>Anthem Market Place</title>
	<meta name="author" content="Feng X.">
	<link rel="stylesheet" type="text/css" href="/static/css/reset-min.css">

	<!-- Channel API, must be the first one! -->
	<script type="text/javascript" src="/_ah/channel/jsapi"></script>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
	<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
	<!--LINK REL=StyleSheet HREF="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/themes/dot-luv/jquery-ui.min.css" TYPE="text/css" MEDIA=screen-->
	<LINK REL=StyleSheet HREF="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.1/themes/smoothness/jquery-ui.min.css" TYPE="text/css" MEDIA=screen>
	<script src="https://maps.google.com/maps/api/js?sensor=true" type="text/javascript"></script>

	<!-- JS to turn a form into AJAX call -->
	<script src="/static/formjs/jquery.form.js"></script> 

	<!-- toast -->
	<script src="/static/toast/jquery.toastmessage.js" type="text/javascript"></script> 
	<LINK REL=StyleSheet HREF="/static/toast/css/jquery.toastmessage.css" TYPE="text/css" MEDIA=screen>
	
	<!-- jQuery dataTable -->
	<script type="text/javascript" src="/static/DataTables-1.9.4/media/js/jquery.dataTables.min.js"></script>
	<LINK REL=StyleSheet HREF="/static/DataTables-1.9.4/media/css/jquery.dataTables.css" TYPE="text/css" MEDIA=screen>
	<link rel="stylesheet" type="text/css" href="/static/beautiful_tables/cell_styles.css">
		
	<!-- carousel -->
	<script type="text/javascript" src="/static/carouFredSel-6.2.0/jquery.carouFredSel-6.2.0.js"></script>

	<!-- easing -->
	<!-- http://gsgd.co.uk/sandbox/jquery/easing/ -->
	<script type="text/javascript" src="/static/easing/jquery.easing.min.js"></script>

	<!-- tinyMCE -->
	<script type="text/javascript" src="/static/tinymce/js/tinymce/jquery.tinymce.min.js"></script>	
	<script type="text/javascript" src="/static/tinymce/js/tinymce/tinymce.min.js"></script>	
		
	<!-- highcharts -->
	<script src="http://code.highcharts.com/highcharts.js"></script>
	
	<LINK REL=StyleShyeet HREF="/static/css/navigation.css" TYPE="text/css" MEDIA=screen>
	<LINK REL=StyleSheet HREF="/static/css/screen.css" TYPE="text/css" MEDIA=screen>
		
	<script type="text/javascript">
	// some global initialization
	var j$=jQuery.noConflict();
 
 	function formatChannelMessage(sender_name,message){
   		var html='';
    	html+='<div class="channel-message">';
    	html+='<span class="channel-sender">';
    	html+=sender_name+'</span>';
    	html+='<br />';
    	html+='<div class="channel-message-content">';
    	html+=message;
    	html+='</div>';
    	html+='</div>';
  		return html;
 	}
 	function refreshChannelMessage(html){
 		// as a circular buffer, showing 10
 		// so the oldest gets bumped off the list
 		
 		var buffer=10;
 		var existing=j$('#channel-displayer').find('div.channel-message');
 		
 		if (existing.length>=buffer){
 			for (var i=0; i<(existing.length-buffer);i++){
 				j$(existing[i]).remove();
 			}
 		}
 		j$('#channel-displayer').append(html);
 		var height=j$('#channel-displayer').outerHeight();
		
		// value "450" is the CSS height of this div#channel-displayer! 		
 		if (parseInt(height)>=450){
 			j$('#channel-displayer').addClass('y-scroll');
 		}else{
 			j$('#channel-displayer').removeClass('y-scroll'); 		
 		}
 	}
 	
	j$(document).ready(function(){
		j$('input[type="date"]').datepicker();

		// channel write message
		j$('input[name="channel-message"]').keypress(function(event) {
			
    		var keycode = (event.keyCode ? event.keyCode : event.which);
        	if(keycode == '13') {
				var receiver_name=j$('input[name="receiver-name"]').val();
				var message=j$('input[name="channel-message"]').val();
				if (receiver_name=='@me'){
					// talking to yourself?
					// why even bother going through the server?									
					j$().toastmessage('showWarningToast','Now you get me worried. Why are you talking to yourself?');
					var html=formatChannelMessage('me',message);
    				refreshChannelMessage(html);
    				
    				// clear input box
    				j$('input[name="channel-message"]').val('');
				}else{
					// Chat only cares about names, not IDs
					// since we maintain channel token on the server side
					// we can look up by contact name
					var data={'sender':'{{ me.nickname }}',
						'receiver':receiver_name,
						'message':message
						}
					j$.post(
						'/channel/route',
						data,
						function(result){
							//j$().toastmessage('showNoticeToast','Sent');
							var html=formatChannelMessage('me',message);
    						refreshChannelMessage(html);
    						
    						// clear input box
    						j$('input[name="channel-message"]').val('');
						}
					);
				}
            }else{
        		var count=j$(this).val().length;
   				j$('#channel-message-character-count').html(count);
            }
        });
                    		
        // channel window animation
		j$('#channel-visible-switch').click(function(){
			j$('#channel-container').show({
				'duration':400,
				'easing':'easeOutSine'
			});
			j$(this).hide();
		});
		j$('#channel-collapse-switch').click(function(){
			j$('#channel-container').hide();
			j$('#channel-visible-switch').fadeIn(400);
		});
		
		// click on channel messag will populate sender input
		j$(document).on('click','div.channel-message',function(){
			var sender=j$(this).find('span.channel-sender:first').html();
			j$('input[name="receiver-name"]').val('@'+sender);
		});
	});
	</script>	
	
	{% block customJS %}{% endblock %}
</head>

{% autoescape true %}
<body>

<script type="text/javascript">    
    /* https://developers.google.com/appengine/docs/python/channel/javascript */
    var token;
    var channel_id;
    
    // MUST ACCALAIM THESE GLOBAL VARIABLES!
    var channel;
    var socket;
    
    function onError(err){
    	j$().toastmessage('showErrorToast','Error code: '+err.code+'<br /> '+err.description);
    }
    
    function onClose(){
    	j$().toastmessage('showNoticeToast','Chat closed! Refresh this page and try again.');
    }
    
    function onMessage(msg){
    	var data=j$.parseJSON(msg.data);
		var html=formatChannelMessage(data['sender_name'],data['message']);	    	
    	refreshChannelMessage(html);
    }
    
    function onOpened(){
    	j$().toastmessage('showSuccessToast','Welcome {{ me.nickname }}');
    }
	function leaseChannel(){
		// channel has default duration of 2 hours
		// so define a function to handle renew
		// token will be randomized on the server side
			
    	j$.post(
    		'/channel/token',
    		{'name':'{{ me.nickname }}',
    		 'user_id':'{{ me.key.id() }}'
    		},
    		function(result){
    			var data=j$.parseJSON(result);
    			token=data['token'];
				channel_id=data['channel_id'];
				    			
				// some global initialization
	    		channel = new goog.appengine.Channel(data['token'].trim());
	    		socket = channel.open();
	    		socket.onopen = onOpened;
	    		socket.onmessage = onMessage;
 	   			socket.onerror = onError;
	    		socket.onclose = onClose;
    		}
    	);
	}
	    
    j$(document).ready(function(){
    	leaseChannel();
    });
</script>

{% block header%}

<div class="header">
	<table class="header-layout">
	<tr><td>
	<h4>Anthem Market Place</h4>
	</td><td>
	<span class="level-1-navigation">
		<ul>		
			<li id="nav-order">
				<a href="/buyorder/browse">
				Shopping
				</a>
			</li>
			<li id="nav-cart">
				<a href="/cart/manage/seller">
				Transaction
				</a>
			</li>			
			<li id="nav-banking">
				<a href="/cart/banking">
				Banking
				</a>
			</li>			
			<li id="nav-user">
				<a href="/user/contact">
				My Profile
				</a>
			</li>
			<li id="nav-report">
				<!-- default to report last 7 days -->
				<a href="/report/buyorder/7/">
				Report
				</a>
			</li>
		</ul>
		</span>
	</td><td style="text-align:right;">
		<span>{{ me.nickname }}</span>
		<a href="{{ url_logout }}" class="bubble-button" style="margin-right:50px;">Logout</a>
	</td></tr>
	</table>
</div>
{% endblock %}

<div class="wrapper">
<table id="site-layout">
<tr>
	<td class="level-2-navigation" style="display:none;">
		{% block level_2_navigation %}
		
		{% endblock %}
	</td>
	<td>
		<div class="main">
		{% block main %}{% endblock %}
		</div>
	</td>
</tr>

</table>

<!-- message pane -->
<span id="channel-visible-switch">Chat</span>
<div class="channel-message-container" style="display:none;" id="channel-container">
	<div class="channel-message-displayer" id="channel-displayer"></div>
	
	<div class="channel-message-writer" style="width:100px;" id="channel-writer">
		<input type="text" name="receiver-name" placeholder="@username"/>
		<br />
		<input type="text" name="channel-message" placeholder=""/>
	</div>
	<span id="channel-message-character-count"></span>/140
	<img src="http://cdn3.iconfinder.com/data/icons/free-blue-button-icons-1/64/Collapse.png" class="channel-collapse-switch" id="channel-collapse-switch"/>
	
</div>

<div class="push"></div>
</div>

{% block footer %}
<div class="footer">
<div style="margin-right:auto;margin-left:auto;width:67%;">
<ul>
<li>&copy; 2013 All Rights Reservered by the Anthem Market Place<br />
	Seraifaith Inc.
</li>

<li>
	<a href="mailto:anthem.marketplace@gmail.com">Contact Us</a>
</li>
<li>
	<a href="">Term of Service</a>

</li>

</ul>
</div>
</div>
{% endblock %}

 
</body>
{% endautoescape %}

</html>
